# 小内存机型（SMALL）统一入口
name: QCA-SMALL

on:
  workflow_dispatch:
    inputs:
      run_variant:
        description: "运行哪种 SMALL 变体（both / wifi / nowifi）"
        required: false
        default: "both"
        type: choice
        options: [both, wifi, nowifi]
  schedule:
    # 按需启用定时（UTC 时间）；如不需要可删除本段
    - cron: "30 20 * * *"

concurrency:
  group: qca-small-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write    # 需要发布 release
  actions: read
  checks: read

jobs:
  small-matrix:
    name: SMALL (${{ matrix.cfg }})

    # ✅ 这里是“调用可复用工作流”的标准写法：
    # 不能再写 runs-on/steps；可以写 strategy/matrix、with、secrets。
    strategy:
      fail-fast: false
      matrix:
        cfg: ${{ fromJSON(
          (inputs.run_variant == 'wifi'   && '["IPQ60XX-SMALL-WIFI"]') ||
          (inputs.run_variant == 'nowifi' && '["IPQ60XX-SMALL-NO"]')   ||
                                             '["IPQ60XX-SMALL-WIFI","IPQ60XX-SMALL-NO"]'
        ) }}

    uses: ./.github/workflows/WRT-CORE.yml
    secrets: inherit
    with:
      # —— 关键：传入 SMALL 的两种配置 ——
      WRT_CONFIG:  ${{ matrix.cfg }}

      # 主题/主机名/WiFi 等常规参数（保持你仓库的一致性）
      WRT_THEME:   argon
      WRT_NAME:    OWRT
      WRT_SSID:    OWRT
      WRT_WORD:    12345678
      WRT_IP:      192.168.1.1
      WRT_PW:      无

      # 源码与分支（保持你当前成功编译的来源）
      WRT_REPO:    https://github.com/VIKINGYFY/immortalwrt.git
      WRT_BRANCH:  main
      WRT_SOURCE:  VIKINGYFY/immortalwrt

      # 额外包（一般留空；SMALL 的 USB/RNDIS、momo/nikki、tailscale
      # 均在 Scripts/Settings.sh 中已按条件自动写入）
      WRT_PACKAGE: ""
      WRT_TEST:    "false"
